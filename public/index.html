<html>
	<head><title>Facebook Profiles</title></head>
	<body>
		<div id="fb-root"></div>
		<script language="JavaScript" src="js/jquery-2.1.1.min.js"></script>
    	<script>
			window.fbAsyncInit = function() {
				FB.init({
					appId      : '1467072543528237',
					status     : true,
					xfbml      : true
				});
				FB.Event.subscribe('auth.authResponseChange', function(response) {
					if (response.status === 'connected') {
						testAPI();
					}else if(response.status === 'not_authorized'){
						FB.login();
					} else {
						FB.login();
					}
				});
			};
			(function(d, s, id){
				var js, fjs = d.getElementsByTagName(s)[0];
				if (d.getElementById(id)) {return;}
				js = d.createElement(s); js.id = id;
				js.src = "//connect.facebook.net/en_US/all.js";
				fjs.parentNode.insertBefore(js, fjs);
			}(document, 'script', 'facebook-jssdk'));

			function accessFBAPI(apiName){
				var dfd = $.Deferred();
				FB.api(apiName, function(response) {
					dfd.resolve(response);
				});
				return dfd.promise();
			}

			var allFriendsId = [];
			var allFriendsName = [];
			function testAPI() {
				//console.log('Welcome! Fetching your information.... ' + FB.getAuthResponse().accessToken);	
				accessFBAPI('/me/friendlists')
				.then(function(list){
						var promises = [];
						for(var i in list.data){
							promises.push(accessFBAPI(list.data[i].id + '/members').done(function(result){
								console.log(JSON.stringify(result));
								for(var j in result.data){
									if($.inArray(result.data[j].name, allFriendsName) == -1){
										allFriendsName.push(result.data[j].name);
										allFriendsId.push(result.data[j].id);
									}
								}
							}));
						}
						return $.when.apply(undefined, promises).promise();
				}).then(function(){
					console.log("after done");
					console.log(allFriendsName);
					console.log(allFriendsName.length)
				});
			}
    	</script>
		<div class="fb-login-button" data-max-rows="10" data-size="large" data-show-faces="true" 
				data-auto-logout-link="true" data-scope='email,user_likes,read_friendlists'></div>
	</body>
</html>
